<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Class Curtain - Cart & Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght[300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="logoo.png" type="image/png">
    
    <style>
        nav { position: sticky; top: 0; left: 0; right: 0; z-index: 1000; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        /* Modal styles */
        .modal-overlay { z-index: 1010; }
        .modal-content { z-index: 1020; }
        
        /* Removed custom progress bar styles to revert to original look */
    </style>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js'

        // NOTE: Replace these with your actual Supabase credentials if necessary
        const SUPABASE_URL = 'https://xyvqvcfdkvvbagqxygwo.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dnF2Y2Zka3Z2YmFncXh5Z3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTAzMjUsImV4cCI6MjA3MzMyNjMyNX0.y9mp2CwTpmBfeu03iQx_2khV2F3SD_xhFTih3WMoMMA'

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        window.supabase = supabase
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'playfair': ['"Playfair Display"', 'serif'], 'poppins': ['Poppins', 'sans-serif'], },
                    colors: { 'primary': '#1a1b4b', 'secondary': '#e6f3ff', }
                }
            }
        }
        function toggleMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
    </script>
</head>
<body class="font-poppins">
    <nav class="bg-white py-4 px-6 md:px-12 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center text-2xl font-playfair font-bold text-primary">
                <img src="logoo.png" alt="World Class Curtain Logo" class="h-10 mr-2" onerror="this.onerror=null; this.src='https://placehold.co/40x40/1a1b4b/ffffff?text=WCC';">
                World Class Curtain
            </a>
            <div class="md:hidden">
                <img src="menuuu.png" alt="Menu Button" class="menu-btn cursor-pointer" id="menu-btn" onclick="toggleMenu()" onerror="this.onerror=null; this.src='https://placehold.co/40x40/1a1b4b/ffffff?text=Menu';">
            </div>
            <div class="hidden md:flex space-x-8 items-center">
                <a href="index.html" class="hover:text-primary">HOME</a>
                <a href="inquiries.html" class="hover:text-primary">INQUIRIES</a>
                <a href="seemore.html" class="hover:text-primary">MORE</a>
                <a href="contact.html" class="hover:text-primary">CONTACT</a>
                <button id="view-orders-btn" class="hover:text-primary relative">
                    <i class="fas fa-history text-xl"></i>
                </button>
                <button id="view-cart-btn" class="hover:text-primary relative">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-item-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <div id="auth-links" class="flex space-x-4">
                    </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white py-4 px-6">
            <a href="index.html" class="block hover:text-primary py-2">HOME</a>
            <a href="inquiries.html" class="hover:text-primary">INQUIRIES</a>
            <a href="seemore.html" class="block hover:text-primary py-2">MORE</a>
            <a href="contact.html" class="block hover:text-primary py-2">CONTACT</a>
            <div id="mobile-auth-links" class="mt-2 space-y-1">
                </div>
            <div class="mt-2">
                <button id="mobile-view-orders-btn" class="text-left w-full hover:text-primary py-2">
                    <i class="fas fa-history mr-2"></i> My Orders
                </button>
                <button id="mobile-view-cart-btn" class="text-left w-full hover:text-primary py-2">
                    <i class="fas fa-shopping-cart mr-2"></i> View Cart 
                </button>
            </div>
        </div>
    </nav>
    
    <main>
        <section id="my-orders" class="py-16 bg-secondary page-section active min-h-[80vh]">
            <div class="container mx-auto px-6 md:px-12">
                <h2 class="text-3xl font-playfair font-bold text-primary text-center mb-8">My Orders History</h2>
                <div id="orders-container" class="space-y-6">
                    <p id="no-orders-message" class="text-center text-gray-500 hidden">Please sign in to view your orders, or you have no past orders. ðŸ›’</p>
                </div>
            </div>
        </section>

        <section id="home-section" class="hidden"></section>
        <section id="products-section" class="hidden"></section>
    </main>

    <footer class="bg-primary text-white py-12">
        <div class="container mx-auto px-6 md:px-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="font-playfair text-xl font-bold mb-4">World Class Curtain</h3>
                    <p class="text-gray-300">Elevate your space with our premium collection of curtains designed for modern living.</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-300 hover:text-white">Home</a></li>
                        <li><a href="accesories.html" class="text-gray-300 hover:text-white">Accessories</a></li>
                        <li><a href="seemore.html" class="text-gray-300 hover:text-white">More</a></li>
                        <li><a href="contact.html" class="text-gray-300 hover:text-white">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-300">
                <p>&copy; 2025 World Class Curtain. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <div id="cart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 modal-content">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-playfair font-bold text-primary">Your Shopping Cart</h2>
                <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="cart-items-container" class="mb-4 max-h-96 overflow-y-auto">
                <p class="text-gray-500">Your cart is empty.</p>
            </div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Subtotal</span>
                    <span id="cart-subtotal" class="font-bold">â‚±0.00</span>
                </div>
                <div class="flex justify-between mb-4">
                    <span class="font-medium">Shipping</span>
                    <span>â‚±50.00</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-primary">
                    <span>Total</span>
                    <span id="cart-total">â‚±50.00</span>
                </div>
                <button id="checkout-btn" class="mt-6 w-full bg-primary text-white py-3 rounded-md hover:bg-opacity-90 transition-colors duration-300 font-semibold" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
    
    <div id="checkout-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 modal-content">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-playfair font-bold text-primary">Checkout</h2>
                <button id="close-checkout-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            
            <form id="checkout-form">
                <h3 class="text-lg font-semibold mb-2">Shipping Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="fullName" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phone" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700">Full Address</label>
                        <input type="text" id="address" class="mt-1 p-2 w-full border rounded-md" placeholder="Street, Barangay, City/Municipality, Province" required>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-2">Payment Method</h3>
                <div class="space-y-2 mb-6">
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-primary">
                        <input type="radio" name="payment" value="Cash on Delivery" class="h-4 w-4 text-primary focus:ring-primary" checked>
                        <span class="ml-3 font-medium">Cash on Delivery (COD)</span>
                    </label>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between text-xl font-bold text-primary">
                        <span>Total to Pay</span>
                        <span id="checkout-total">â‚±0.00</span>
                    </div>
                    <div class="flex justify-between mt-6 space-x-4">
                        <button id="back-to-cart-btn" type="button" class="w-1/2 bg-gray-300 text-gray-700 py-3 rounded-md hover:bg-gray-400 transition-colors duration-300 font-semibold">
                            Back to Cart
                        </button>
                        <button type="submit" class="w-1/2 bg-primary text-white py-3 rounded-md hover:bg-opacity-90 transition-colors duration-300 font-semibold">
                            Place Order
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        const supabase = window.supabase;

        // --- DOM Selectors ---
        const cartModal = document.getElementById('cart-modal');
        const checkoutModal = document.getElementById('checkout-modal');
        const viewCartBtn = document.getElementById('view-cart-btn');
        const mobileViewCartBtn = document.getElementById('mobile-view-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const closeCheckoutBtn = document.getElementById('close-checkout-btn');
        const checkoutForm = document.getElementById('checkout-form');
        const cartItemCount = document.getElementById('cart-item-count');
        const myOrdersBtn = document.getElementById('view-orders-btn');
        const mobileMyOrdersBtn = document.getElementById('mobile-view-orders-btn');
        const backToCartBtn = document.getElementById('back-to-cart-btn');
        const authLinksContainer = document.getElementById('auth-links');
        const mobileAuthLinksContainer = document.getElementById('mobile-auth-links');
        const shippingCost = 50.00; // Define shipping cost once

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }
        }

        async function updateCartCount() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                cartItemCount.textContent = '0';
                return;
            }
            const { count, error } = await supabase
                .from('cart')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', session.user.id);
            
            cartItemCount.textContent = error ? '0' : (count || '0');
        }

        async function viewCart() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                // Using a custom modal/message box instead of alert() for better UX
                const customAlert = document.createElement('div');
                customAlert.className = "fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1050]";
                customAlert.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm text-center">
                        <p class="font-semibold text-primary mb-4">Please sign in to view your cart.</p>
                        <button onclick="document.getElementById('cart-modal').classList.add('hidden'); window.location.href = 'login.html';" class="bg-primary text-white py-2 px-4 rounded-md hover:bg-opacity-90">Go to Sign In</button>
                    </div>
                `;
                document.body.appendChild(customAlert);
                setTimeout(() => customAlert.remove(), 3000); // Auto-remove after 3 seconds if user doesn't click
                return;
            }

            const { data: cartItems, error } = await supabase
                .from('cart')
                .select('*')
                .eq('user_id', session.user.id);

            if (error) {
                console.error('Error fetching cart items:', error);
                // alert('Could not fetch cart items.');
                return;
            }

            const container = document.getElementById('cart-items-container');
            if (cartItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Your cart is empty.</p>';
                document.getElementById('cart-subtotal').textContent = 'â‚±0.00';
                document.getElementById('cart-total').textContent = `â‚±${shippingCost.toFixed(2)}`;
                checkoutBtn.disabled = true;
                checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                container.innerHTML = '';
                let subtotal = 0;
                cartItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    const itemPrice = item.price * item.quantity;
                    itemElement.className = 'flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0';
                    itemElement.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="https://placehold.co/60x60/f3f4f6/1a1b4b?text=Curtain" alt="${item.product_name}" class="rounded-lg">
                            <div>
                                <p class="font-semibold text-primary">${item.product_name}</p>
                                <p class="text-xs text-gray-500">${item.size} | Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="font-bold text-lg text-green-600">â‚±${itemPrice.toFixed(2)}</span>
                            <button class="remove-from-cart-btn text-red-500 hover:text-red-700 transition" data-id="${item.id}" data-quantity="${item.quantity}">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(itemElement);
                    subtotal += itemPrice;
                });

                document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                    button.addEventListener('click', handleRemoveFromCart);
                });

                const total = subtotal + shippingCost;
                
                document.getElementById('cart-subtotal').textContent = `â‚±${subtotal.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `â‚±${total.toFixed(2)}`;
                document.getElementById('checkout-total').textContent = `â‚±${total.toFixed(2)}`;
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            cartModal.classList.remove('hidden');
        }

        function showCustomMessage(message, type = 'info') {
             const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-primary';
             const existingMessage = document.getElementById('custom-alert-message');
             if(existingMessage) existingMessage.remove();

             const messageElement = document.createElement('div');
             messageElement.id = 'custom-alert-message';
             messageElement.className = `fixed top-5 left-1/2 -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-xl z-[1060] transition-opacity duration-300`;
             messageElement.textContent = message;
             document.body.appendChild(messageElement);

             setTimeout(() => {
                 messageElement.classList.add('opacity-0');
                 setTimeout(() => messageElement.remove(), 300);
             }, 3000);
         }

        function showCustomConfirm(message, callback) {
            const modalHtml = `
                <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1050]">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center">
                        <p class="font-semibold text-primary mb-6">${message}</p>
                        <div class="flex justify-around space-x-4">
                            <button id="confirm-cancel" class="flex-1 bg-gray-300 text-gray-800 py-2 rounded-md hover:bg-gray-400 font-medium">Cancel</button>
                            <button id="confirm-ok" class="flex-1 bg-primary text-white py-2 rounded-md hover:bg-opacity-90 font-medium">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = document.getElementById('custom-confirm-modal');

            document.getElementById('confirm-ok').addEventListener('click', () => {
                modal.remove();
                callback(true);
            });
            document.getElementById('confirm-cancel').addEventListener('click', () => {
                modal.remove();
                callback(false);
            });
        }
        
        async function handleRemoveFromCart(event) {
            const itemId = event.currentTarget.dataset.id;
            const currentQuantity = parseInt(event.currentTarget.dataset.quantity);
            
            if (currentQuantity > 1) {
                // Option 1: Quantity > 1, so decrement the quantity
                const newQuantity = currentQuantity - 1;

                showCustomConfirm(`Reduce quantity to ${newQuantity}?`, async (confirmed) => {
                    if (!confirmed) return;

                    const { error } = await supabase
                        .from('cart')
                        .update({ quantity: newQuantity })
                        .eq('id', itemId);

                    if (error) {
                        console.error("Error decrementing item quantity:", error);
                        showCustomMessage("Sorry, there was an error updating the quantity.", 'error');
                    } else {
                        showCustomMessage("Item quantity reduced.", 'success');
                        viewCart(); 
                        updateCartCount(); 
                    }
                });

            } else {
                // Option 2: Quantity is 1, so delete the item entirely
                showCustomConfirm('Remove this item entirely from your cart?', async (confirmed) => {
                    if (!confirmed) return;

                    const { error } = await supabase
                        .from('cart')
                        .delete()
                        .eq('id', itemId);

                    if (error) {
                        console.error("Error removing item:", error);
                        showCustomMessage("Sorry, there was an error removing the item.", 'error');
                    } else {
                        showCustomMessage("Item removed from cart!", 'success');
                        viewCart(); 
                        updateCartCount(); 
                    }
                });
            }
        }
        
        function proceedToCheckout() {
            cartModal.classList.add('hidden');
            checkoutModal.classList.remove('hidden');
        }

        async function placeOrder(event) {
            event.preventDefault();

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                showCustomMessage("Your session has expired. Please log in again.", 'error');
                return;
            }

            const { data: cartItems, error: cartError } = await supabase
                .from('cart')
                .select('product_name, size, price, quantity')
                .eq('user_id', session.user.id);
            
            if (cartError || !cartItems || cartItems.length === 0) {
                showCustomMessage("Could not retrieve cart items to place order. Your cart might be empty.", 'error');
                return;
            }

            // Client-side validation
            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            if (!fullName || !phone || !address) {
                showCustomMessage("Please fill out all shipping information fields.", 'error');
                return;
            }

            const shippingAddressObject = {
                fullName: fullName,
                phone: phone,
                address: address,
            };
            const payment_method = document.querySelector('input[name="payment"]:checked').value;
            const total_price = parseFloat(document.getElementById('checkout-total').textContent.replace('â‚±', '').replace(',', ''));

            const order = {
                user_id: session.user.id,
                order_items: JSON.stringify(cartItems),
                total_price: total_price,
                shipping_address: JSON.stringify(shippingAddressObject),
                payment_method: payment_method,
                // Initial status set to 'Processed' after successful checkout
                status: 'Processed' 
            };

            const { error: orderError } = await supabase.from('orders').insert([order]);
            
            if (orderError) {
                console.error("Error placing order:", orderError);
                showCustomMessage("There was a problem placing your order. Please try again.", 'error');
                return;
            }

            // Clear cart upon successful order placement
            await supabase.from('cart').delete().eq('user_id', session.user.id);
            
            showCustomMessage('ðŸŽ‰ Order placed successfully! Thank you for your purchase. It is now being processed.', 'success');
            checkoutModal.classList.add('hidden');
            updateCartCount();
            viewMyOrders(); // Automatically show the orders section after placing an order
        }

        
        /**
         * Generates a simple colored badge for the order status.
         */
        function getStatusBadgeHtml(status) {
            let classes = '';
            let label = status;

            // Mapping statuses to colors (Processed -> Shipped -> Delivered)
            switch (status) {
                case 'Processed':
                    classes = 'bg-yellow-100 text-yellow-800';
                    label = 'Processing';
                    break;
                case 'Shipped':
                    classes = 'bg-blue-100 text-blue-800';
                    break;
                case 'Delivered':
                    classes = 'bg-green-100 text-green-800';
                    break;
                case 'Cancelled':
                    classes = 'bg-red-100 text-red-800';
                    break;
                default: 
                    classes = 'bg-gray-100 text-gray-800';
                    label = 'Ordered';
                    break;
            }
            // Use a standard badge look
            return `<span class="px-3 py-1 text-sm font-semibold rounded-full ${classes}">${label}</span>`;
        }


        async function viewMyOrders() {
            const { data: { session } } = await supabase.auth.getSession();
            const noOrdersMessage = document.getElementById('no-orders-message');

            if (!session) {
                noOrdersMessage.textContent = 'Please sign in to view your orders.';
                noOrdersMessage.classList.remove('hidden');
                showSection('my-orders');
                return;
            }

            showSection('my-orders');
            noOrdersMessage.classList.add('hidden'); // Hide general message while loading

            const { data: orders, error } = await supabase
                .from('orders')
                .select('*')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false });

            const ordersContainer = document.getElementById('orders-container');
            ordersContainer.innerHTML = '';
            ordersContainer.appendChild(noOrdersMessage); // Re-add the message container

            if (error) {
                console.error("Error fetching orders:", error);
                noOrdersMessage.textContent = 'Failed to load orders.';
                noOrdersMessage.classList.remove('hidden');
                return;
            }

            if (!orders || orders.length === 0) {
                noOrdersMessage.textContent = 'You have no past orders. Go shopping now! ðŸ›’';
                noOrdersMessage.classList.remove('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                orders.forEach(order => {
                    const orderDate = new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    // Ensure parsing is safe
                    const items = JSON.parse(order.order_items || '[]');
                    const address = JSON.parse(order.shipping_address || '{}');

                    // --- REVERTED: Use the simple status badge HTML ---
                    const statusBadgeHtml = getStatusBadgeHtml(order.status);
                    
                    const orderElement = document.createElement('div');
                    orderElement.className = 'bg-white p-6 rounded-xl shadow-lg border-t-8 border-primary md:p-8';
                    
                    let itemsHtml = items.map(item => `
                        <div class="flex justify-between text-sm py-2 border-b border-gray-100">
                            <span class="text-gray-700 font-medium">${item.product_name} (${item.size})</span>
                            <span class="font-bold text-primary">Qty: ${item.quantity}</span>
                        </div>
                    `).join('');

                    orderElement.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-4">
                            <h3 class="text-xl font-playfair font-bold text-primary">Order #${order.id}</h3>
                            <p class="text-sm text-gray-500 mt-1 md:mt-0">Placed on: ${orderDate}</p>
                        </div>
                        
                        <div class="mb-4 pt-2">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Delivery Status:</h4>
                            ${statusBadgeHtml}
                        </div>
                        <div class="space-y-1 mb-4 pt-4 border-t">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Items Ordered:</h4>
                            ${itemsHtml}
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <div class="flex justify-between font-bold text-xl mb-3">
                                <span>Total Paid</span>
                                <span class="text-green-600">â‚±${order.total_price.toFixed(2)}</span>
                            </div>
                            <p class="text-sm text-gray-600"><span class="font-medium">Payment Method:</span> ${order.payment_method}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Ship To:</span> ${address.fullName || 'N/A'} (Tel: ${address.phone || 'N/A'})</p>
                            <p class="text-sm text-gray-600">${address.address || 'N/A'}</p>
                        </div>
                    `;
                    ordersContainer.appendChild(orderElement);
                });
            }
        }

        // --- Authentication ---
        async function checkUserSession() {
            const { data: { session } } = await supabase.auth.getSession();
            updateUIAfterAuth(session);
            updateCartCount(session);
            // Default action for cart.html is to show orders
            viewMyOrders();
        }

        function updateUIAfterAuth(session) {
            authLinksContainer.innerHTML = ''; 
            mobileAuthLinksContainer.innerHTML = '';

            if (session && session.user) {
                const desktopLinks = `
                    <a href="profile.html" class="hover:text-primary font-semibold">PROFILE</a>
                    <button id="signout-btn" class="hover:text-primary font-semibold">SIGN OUT</button>
                `;
                const mobileLinks = `
                    <a href="profile.html" class="block hover:text-primary py-2">PROFILE</a>
                    <button id="mobile-signout-btn" class="block hover:text-primary py-2 w-full text-left">SIGN OUT</button>
                `;
                authLinksContainer.innerHTML = desktopLinks;
                mobileAuthLinksContainer.innerHTML = mobileLinks;

                document.getElementById('signout-btn').addEventListener('click', signOut);
                document.getElementById('mobile-signout-btn').addEventListener('click', signOut);

            } else {
                const desktopLinks = `
                    <a href="login.html" class="hover:text-primary font-semibold">SIGN IN</a>
                    <a href="signup.html" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-opacity-90 font-semibold">SIGN UP</a>
                `;
                const mobileLinks = `
                    <a href="login.html" class="block hover:text-primary py-2">SIGN IN</a>
                    <a href="signup.html" class="block hover:text-primary py-2">SIGN UP</a>
                `;
                authLinksContainer.innerHTML = desktopLinks;
                mobileAuthLinksContainer.innerHTML = mobileLinks;
            }
        }

        async function signOut() {
            showCustomConfirm('Are you sure you want to sign out?', async (confirmed) => {
                if (confirmed) {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        showCustomMessage('Error signing out.', 'error');
                    } else {
                        showCustomMessage('You have been signed out.', 'success');
                        updateUIAfterAuth(null);
                        updateCartCount();
                        viewMyOrders(); // Refresh orders section (will show "please sign in")
                    }
                }
            });
        }

        // --- Event Listeners ---
        viewCartBtn.addEventListener('click', viewCart);
        mobileViewCartBtn.addEventListener('click', viewCart);
        closeCartBtn.addEventListener('click', () => cartModal.classList.add('hidden'));
        checkoutBtn.addEventListener('click', proceedToCheckout);
        closeCheckoutBtn.addEventListener('click', () => checkoutModal.classList.add('hidden'));
        backToCartBtn.addEventListener('click', () => {
            checkoutModal.classList.add('hidden');
            cartModal.classList.remove('hidden');
        });
        checkoutForm.addEventListener('submit', placeOrder);

        // Click handlers for the "My Orders" buttons
        myOrdersBtn.addEventListener('click', viewMyOrders);
        mobileMyOrdersBtn.addEventListener('click', viewMyOrders);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkUserSession();
        });

    </script>
</body>
</html>