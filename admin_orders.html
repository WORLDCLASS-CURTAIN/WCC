    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin - Order Management</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="icon" href="logoo.png" type="image/png">

        <style>
            .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; }
            /* Added from index.html for the new nav */
            nav { position: sticky; top: 0; left: 0; right: 0; z-index: 1000; }
        </style>

        <script type="module">
            import { createClient } from 'https://esm.sh/@supabase/supabase-js'

            const SUPABASE_URL = 'https://xyvqvcfdkvvbagqxygwo.supabase.co'
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5dnF2Y2Zka3Z2YmFncXh5Z3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTAzMjUsImV4cCI6MjA3MzMyNjMyNX0.y9mp2CwTpmBfeu03iQx_2khV2F3SD_xhFTih3WMoMMA'

            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
            window.supabase = supabase

            // ðŸ”‘ OWNER CONFIGURATION - REPLACE THIS WITH YOUR ADMIN USER'S UUID!
            const OWNER_USER_ID = 'a07429ce-d43a-4c8f-aedf-07e06dd4ca64'; 
            window.OWNER_USER_ID = OWNER_USER_ID; 

            tailwind.config = {
                theme: { extend: { fontFamily: { 'playfair': ['"Playfair Display"', 'serif'], 'poppins': ['Poppins', 'sans-serif'], }, colors: { 'primary': '#1a1b4b', 'secondary': '#e6f3ff', } } }
            }

            // --- DOM Selectors ---
            const authLinksContainer = document.getElementById('auth-links');
            const mobileAuthLinksContainer = document.getElementById('mobile-auth-links');
            // Note: cartItemCount is no longer used but kept as a placeholder to avoid breaking nav if logic were reintroduced
            const cartItemCount = document.getElementById('cart-item-count'); 
            const userWelcomeSection = document.getElementById('user-welcome') || {}; 
            const userEmailDisplay = document.getElementById('user-email-display') || {};


            // --- Authentication ---
            async function checkUserSession() {
                const { data: { session } } = await supabase.auth.getSession();
                updateUIAfterAuth(session);
                // updateCartCount(session); // REMOVED: Cart logic is not needed for admin page
            }

            // This updates the nav bar UI
            function updateUIAfterAuth(session) {
                authLinksContainer.innerHTML = ''; // Clear previous links
                mobileAuthLinksContainer.innerHTML = '';

                const isOwner = session && session.user.id === OWNER_USER_ID;

                if (session && session.user) {
                    // User is logged in
                    if (userWelcomeSection.classList) userWelcomeSection.classList.remove('hidden');
                    if (userEmailDisplay.textContent) userEmailDisplay.textContent = `Signed in as: ${session.user.email}`;

                    let adminLinkDesktop = '';
                    if (isOwner) {
                        // Current link for this page is already bolded and red
                        adminLinkDesktop = `<a href="admin_orders.html" class="hover:text-red-600 font-bold text-red-500">ADMIN ORDERS</a>`;
                    }

                    const desktopLinks = `
                        ${adminLinkDesktop}
                        <a href="profile.html" class="hover:text-primary font-semibold">PROFILE</a>
                        <button id="signout-btn" class="hover:text-primary font-semibold">SIGN OUT</button>
                    `;

                    let adminLinkMobile = '';
                    if (isOwner) {
                        adminLinkMobile = `<a href="admin_orders.html" class="block hover:text-red-600 py-2 font-bold text-red-500">ADMIN ORDERS</a>`;
                    }

                    const mobileLinks = `
                        ${adminLinkMobile}
                        <a href="profile.html" class="block hover:text-primary py-2">PROFILE</a>
                        <button id="mobile-signout-btn" class="block hover:text-primary py-2 w-full text-left">SIGN OUT</button>
                    `;

                    authLinksContainer.innerHTML = desktopLinks;
                    mobileAuthLinksContainer.innerHTML = mobileLinks;

                    document.getElementById('signout-btn').addEventListener('click', handleSignOut);
                    document.getElementById('mobile-signout-btn').addEventListener('click', handleSignOut);

                } else {
                    // User is not logged in
                    if (userWelcomeSection.classList) userWelcomeSection.classList.add('hidden');
                    const desktopLinks = `<a href="login.html" class="hover:text-primary font-semibold">SIGN IN</a>`;
                    const mobileLinks = `<a href="login.html" class="block hover:text-primary py-2">SIGN IN</a>`;
                    authLinksContainer.innerHTML = desktopLinks;
                    mobileAuthLinksContainer.innerHTML = mobileLinks;
                }
            }

            // This handles signout from the new nav
            async function handleSignOut() {
                await supabase.auth.signOut();
                window.location.href = 'index.html'; // Go to home after sign out
            }

            // --- Cart Logic (REMOVED) ---
            /*
            async function updateCartCount(session) {
                if (!session) {
                    if (cartItemCount) cartItemCount.textContent = '0';
                    return;
                }
                const { count, error } = await supabase
                    .from('cart')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', session.user.id);

                if (cartItemCount) cartItemCount.textContent = error ? '0' : (count || '0');
            }
            */

            // --- Admin Authentication Check ---
            async function checkAdminAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                document.getElementById('loading-overlay').classList.add('hidden');

                if (!session || session.user.id !== OWNER_USER_ID) {
                    alert('Access Denied. You must be the administrator.');
                    window.location.href = 'index.html';
                    return false;
                }
                document.getElementById('admin-content').classList.remove('hidden');
                return true;
            }

            // --- Status Update Function ---
            async function updateOrderStatus(orderId, newStatus) {
                const { data: { session } } = await supabase.auth.getSession();

                if (!session || session.user.id !== OWNER_USER_ID) {
                    alert('ðŸš« Permission Denied: You are not the owner.');
                    return;
                }

                if (!confirm(`Confirm status change for Order #${orderId.substring(0, 8)} to "${newStatus}"?`)) {
                    // Reset dropdown if user cancels
                    fetchAllOrders();
                    return;
                }

                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);

                if (error) {
                    console.error("Error updating order status:", error);
                    alert(`Failed to update status for Order #${orderId.substring(0, 8)}. Check RLS policy.`);
                } else {
                    alert(`Status updated to: ${newStatus}`);
                    fetchAllOrders(); // Refresh the list
                }
            }
            window.updateOrderStatus = updateOrderStatus;

            // --- Bulk Acceptance Function ---
            async function acceptAllPendingOrders() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || session.user.id !== window.OWNER_USER_ID) {
                    alert('ðŸš« Permission Denied.');
                    return;
                }

                if (!confirm('Are you sure you want to change ALL Pending orders to Processing?')) {
                    return;
                }

                const { count, error } = await supabase
                    .from('orders')
                    .update({ status: 'Processing' })
                    .eq('status', 'Pending')
                    .select('*', { count: 'exact' }); 

                if (error) {
                    console.error("Error accepting pending orders:", error);
                    alert('Failed to accept pending orders.');
                } else {
                    alert(`${count} order(s) have been moved to Processing.`);
                    fetchAllOrders(); // Refresh the list
                }
            }
            window.acceptAllPendingOrders = acceptAllPendingOrders;


            // --- Fetch and Display All Orders (Kept as requested) ---
            async function fetchAllOrders() {
                // The checkAdminAuth() in DOMContentLoaded already secured the page
                const ordersContainer = document.getElementById('orders-container');
                ordersContainer.innerHTML = '<p class="text-center text-primary font-semibold">Loading orders...</p>';

                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                ordersContainer.innerHTML = ''; 

                if (error || !orders || orders.length === 0) {
                    ordersContainer.innerHTML = `<p class="text-center text-gray-500">${error ? 'Error loading orders.' : 'No orders found.'}</p>`;
                    return;
                }

                orders.forEach(order => {
                    const orderDate = new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const items = JSON.parse(order.order_items || '[]');
                    const address = JSON.parse(order.shipping_address || '{}');

                    let statusColor = 'bg-gray-100 text-gray-800';
                    if (order.status === 'Pending') statusColor = 'bg-yellow-100 text-yellow-800';
                    else if (order.status === 'Processing') statusColor = 'bg-orange-100 text-orange-800';
                    else if (order.status === 'Shipped') statusColor = 'bg-blue-100 text-blue-800';
                    else if (order.status === 'Delivered') statusColor = 'bg-green-100 text-green-800';
                    else if (order.status === 'Cancelled') statusColor = 'bg-red-100 text-red-800';

                    // Status Dropdown
                    const statuses = ['Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled'];
                    const statusOptions = statuses.map(status => `
                        <option value="${status}" ${order.status === status ? 'selected' : ''}>
                            ${status}
                        </option>
                    `).join('');

                    const statusUpdater = `
                        <select 
                            class="px-3 py-1 text-sm font-semibold rounded-md border border-gray-300 focus:ring-primary focus:border-primary cursor-pointer ${statusColor}"
                            onchange="updateOrderStatus('${order.id}', this.value)"
                        >
                            ${statusOptions}
                        </select>
                    `;

                    let itemsHtml = items.map(item => `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200">
                            <span class="text-gray-700">${item.product_name} (${item.size})</span>
                            <span class="font-medium">Qty: ${item.quantity} x â‚±${item.price.toFixed(2)}</span>
                        </div>
                    `).join('');

                    const orderElement = document.createElement('div');
                    orderElement.className = 'bg-white p-6 rounded-lg shadow-xl border-t-4 border-primary';

                    orderElement.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-primary">Order #${order.id.substring(0, 8)}...</h3>
                            ${statusUpdater}
                        </div>
                        <p class="text-sm text-gray-500 mb-2">Placed on: ${orderDate}</p>
                        <p class="text-sm text-gray-500 mb-4">Customer ID: ${order.user_id.substring(0, 8)}...</p>

                        <h4 class="font-semibold mt-4 mb-2">Items:</h4>
                        <div class="space-y-1 mb-4">
                            ${itemsHtml}
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between font-bold text-lg mb-2">
                                <span>Total Paid</span>
                                <span>â‚±${order.total_price.toFixed(2)}</span>
                            </div>
                            <p class="text-sm text-gray-600">Payment: ${order.payment_method}</p>
                            <p class="text-sm text-gray-600">Ship to: ${address.fullName || 'N/A'}, ${address.address || 'N/A'} - ${address.phone || 'N/A'}</p>
                        </div>
                    `;
                    ordersContainer.appendChild(orderElement);
                });
            }

            // --- UPDATED Event Listener ---
            document.addEventListener('DOMContentLoaded', async () => {
                // 1. Populate the nav bar
                checkUserSession(); 

                // 2. Check admin auth to secure the page
                if (await checkAdminAuth()) {
                    // 3. If admin is confirmed, fetch admin-specific data
                    fetchAllOrders();
                }
            });
        </script>

        <script>
            function toggleMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
        </script>

    </head>
    <body class="font-poppins bg-gray-100">

        <div id="loading-overlay" class="loading-overlay">
            <div class="text-xl font-semibold text-primary">Checking Authorization...</div>
        </div>

        <nav class="bg-white py-4 px-6 md:px-12 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <a href="index.html" class="flex items-center text-2xl font-playfair font-bold text-primary">
                    <img src="logoo.png" alt="World Class Curtain Logo" class="h-10 mr-2">
                    World Class Curtain
                </a>
                <div class="md:hidden">
                    <img src="menuuu.png" alt="Menu Button" class="menu-btn cursor-pointer" id="menu-btn" onclick="toggleMenu()">
                </div>
                <div class="hidden md:flex space-x-8 items-center">
                    <a href="index.html" class="hover:text-primary">HOME</a>
                    <a href="inquiries.html" class="hover:text-primary">INQUIRIES</a>
                    <a href="accesories.html" class="hover:text-primary">ACCESSORIES</a>
                    <a href="seemore.html" class="hover:text-primary">MORE</a>
                    <a href="contact.html" class="hover:text-primary">CONTACT</a>
                    <div id="auth-links" class="flex space-x-4 items-center"></div> 
                    </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden bg-white py-4 px-6">
                <a href="index.html" class="block hover:text-primary py-2">HOME</a>
                <a href="inquiries.html" class="hover:text-primary">INQUIRIES</a>
                <a href="accesories.html" class="hover:text-primary">ACCESSORIES</a>
                <a href="seemore.html" class="block hover:text-primary py-2">MORE</a>
                <a href="contact.html" class="block hover:text-primary py-2">CONTACT</a>
                <a href="developers.html" class="block hover:text-primary py-2">DEVELOPERS</a>
                <div id="mobile-auth-links" class="mt-2 space-y-1"></div> 
            </div>
        </nav>

        <div id="admin-content" class="hidden">
            <main class="py-16">
                <div class="container mx-auto px-6 md:px-12">
                    <h2 class="text-3xl font-playfair font-bold text-primary text-center mb-10">All Customer Orders</h2>

                    <div class="text-center mb-10">
                        <button 
                            onclick="acceptAllPendingOrders()"
                            class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-lg"
                        >
                            <i class="fas fa-check-double mr-2"></i> Accept All Pending Orders
                        </button>
                    </div>

                    <div id="orders-container" class="space-y-8 max-w-4xl mx-auto">
                        </div>
                </div>
            </main>

            <footer class="bg-primary text-white py-6 text-center mt-10">
                <p>&copy; 2025 Admin Portal.</p>
            </footer>
        </div>
    </body>
    </html>